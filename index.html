<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VNB - מערכת ניהול</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; font-family: system-ui, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const initialProducts = [
      { id: 1, name: 'בורג 35*2.5', boxesPerCarton: 20, screwsPerBox: 1000, pricePerBox: 13, costPerBox: 6.5, minStock: 5, initialStock: 68, notes: '' },
      { id: 2, name: 'בורג 35*3.5', boxesPerCarton: 16, screwsPerBox: 1000, pricePerBox: 19, costPerBox: 9.5, minStock: 5, initialStock: 26, notes: '' },
      { id: 3, name: 'בורג 4.2*13', boxesPerCarton: 20, screwsPerBox: 1000, pricePerBox: 17, costPerBox: 8.5, minStock: 5, initialStock: 42, notes: '' },
      { id: 4, name: 'בורג 4.8*3.5', boxesPerCarton: 16, screwsPerBox: 500, pricePerBox: 18, costPerBox: 9, minStock: 5, initialStock: 72, notes: '' },
    ];

    const initialCustomers = [
      { id: 1, name: 'נור רחמים', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 2, name: 'אשל חומרי בניין', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 3, name: 'סימן טוב חומרי בניין', phone: '', address: 'אשדוד', contactPerson: 'ויקטור', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'דרום' },
      { id: 4, name: 'אבו שושה חומרי בניין', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 5, name: 'אבידן בתי עץ', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 6, name: 'אחים הרוש', phone: '', address: '', contactPerson: '', paymentTerms: 'צק', rating: 5, notes: '', region: 'מרכז' },
      { id: 7, name: 'עולם השלד', phone: '', address: 'תל אביב', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 8, name: 'חומרי בניין פרימור ראשלצ', phone: '', address: 'ראשון לציון', contactPerson: '', paymentTerms: 'שוטף+60', rating: 5, notes: '', region: 'מרכז' },
      { id: 9, name: 'זנו חומרי בניין קרית מלאכי', phone: '', address: 'קרית מלאכי', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'דרום' },
      { id: 10, name: 'עידן כחלון קרית מלאכי', phone: '', address: 'קרית מלאכי', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'דרום' },
      { id: 11, name: 'בראשית גדרה', phone: '', address: 'גדרה', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 12, name: 'אחים ללזרי', phone: '', address: '', contactPerson: '', paymentTerms: 'שוטף+60', rating: 5, notes: '', region: 'מרכז' },
      { id: 13, name: 'אדירים', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 14, name: 'אבו חיידר', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
      { id: 15, name: 'בן ישי', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 5, notes: '', region: 'מרכז' },
    ];

    const initialSales = [
      { id: 1, date: '2025-12-27', customerId: 1, items: [{productId: 1, cartons: 3, pricePerBox: 13}, {productId: 2, cartons: 2, pricePerBox: 19}, {productId: 3, cartons: 1, pricePerBox: 17}, {productId: 4, cartons: 2, pricePerBox: 9}], paymentStatus: 'שולם', paymentDueDate: '', notes: 'קרטון של 16 קופסאות מעורב אצלי לפרסום', invoiceNumber: 'INV-001', payments: [{ date: '2025-12-27', amount: 2378.88, method: 'מזומן', reference: '' }] },
      { id: 2, date: '2025-12-27', customerId: 2, items: [{productId: 1, cartons: 2, pricePerBox: 6.5}, {productId: 2, cartons: 1, pricePerBox: 19}, {productId: 3, cartons: 1, pricePerBox: 17}, {productId: 4, cartons: 1, pricePerBox: 18}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-002', payments: [{ date: '2025-12-27', amount: 1406.56, method: 'מזומן', reference: '' }] },
      { id: 3, date: '2025-12-28', customerId: 3, items: [{productId: 1, cartons: 2, pricePerBox: 13}, {productId: 2, cartons: 1, pricePerBox: 19}, {productId: 3, cartons: 2, pricePerBox: 17}, {productId: 4, cartons: 5, pricePerBox: 17.5}], paymentStatus: 'שולם', paymentDueDate: '', notes: 'אצל ויקטור', invoiceNumber: 'INV-003', payments: [{ date: '2025-12-28', amount: 3426.72, method: 'ביט', reference: 'ניקא' }] },
      { id: 4, date: '2025-12-29', customerId: 4, items: [{productId: 1, cartons: 2, pricePerBox: 13}, {productId: 2, cartons: 1, pricePerBox: 19}, {productId: 3, cartons: 2, pricePerBox: 17}, {productId: 4, cartons: 5, pricePerBox: 17.5}], paymentStatus: 'חלקי', paymentDueDate: '', notes: 'יתרה 1900', invoiceNumber: 'INV-004', payments: [{ date: '2025-12-29', amount: 1000, method: 'ביט', reference: 'ניקא 1000' }] },
      { id: 5, date: '2025-12-30', customerId: 5, items: [{productId: 1, cartons: 1, pricePerBox: 13}, {productId: 2, cartons: 2, pricePerBox: 19}, {productId: 3, cartons: 1, pricePerBox: 17}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-005', payments: [{ date: '2025-12-30', amount: 1425.44, method: 'מזומן', reference: '' }] },
      { id: 6, date: '2026-01-01', customerId: 6, items: [{productId: 1, cartons: 2, pricePerBox: 13}, {productId: 2, cartons: 2, pricePerBox: 19}, {productId: 3, cartons: 2, pricePerBox: 17}, {productId: 4, cartons: 4, pricePerBox: 18}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-006', payments: [{ date: '2026-01-01', amount: 3492.8, method: 'צק', reference: '' }] },
      { id: 7, date: '2026-01-07', customerId: 7, items: [{productId: 2, cartons: 2, pricePerBox: 19}, {productId: 4, cartons: 36, pricePerBox: 18}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-007', payments: [{ date: '2026-01-07', amount: 12951.68, method: 'מזומן', reference: '' }] },
      { id: 8, date: '2026-01-08', customerId: 8, items: [{productId: 1, cartons: 1, pricePerBox: 13}, {productId: 3, cartons: 1, pricePerBox: 17}, {productId: 4, cartons: 1, pricePerBox: 18}], paymentStatus: 'ממתין', paymentDueDate: '2026-03-08', notes: '', invoiceNumber: 'INV-008', payments: [] },
      { id: 9, date: '2026-01-09', customerId: 9, items: [{productId: 1, cartons: 2, pricePerBox: 13}, {productId: 3, cartons: 1, pricePerBox: 17}, {productId: 4, cartons: 1, pricePerBox: 18}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-009', payments: [{ date: '2026-01-09', amount: 1354.64, method: 'מזומן', reference: '' }] },
      { id: 10, date: '2026-01-09', customerId: 10, items: [{productId: 1, cartons: 4, pricePerBox: 13}, {productId: 2, cartons: 1, pricePerBox: 19}, {productId: 3, cartons: 1, pricePerBox: 17}, {productId: 4, cartons: 1, pricePerBox: 18}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-010', payments: [{ date: '2026-01-09', amount: 2326.96, method: 'מזומן', reference: '' }] },
      { id: 11, date: '2026-01-09', customerId: 11, items: [{productId: 1, cartons: 2, pricePerBox: 13}, {productId: 2, cartons: 1, pricePerBox: 19}, {productId: 3, cartons: 1, pricePerBox: 17}, {productId: 4, cartons: 1, pricePerBox: 18}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-011', payments: [{ date: '2026-01-09', amount: 1713.36, method: 'מזומן', reference: '' }] },
      { id: 12, date: '2026-01-11', customerId: 12, items: [{productId: 1, cartons: 3, pricePerBox: 13}, {productId: 2, cartons: 2, pricePerBox: 19}, {productId: 3, cartons: 2, pricePerBox: 17}, {productId: 4, cartons: 3, pricePerBox: 18}], paymentStatus: 'ממתין', paymentDueDate: '2026-03-11', notes: '', invoiceNumber: 'INV-012', payments: [] },
      { id: 13, date: '2026-01-13', customerId: 13, items: [{productId: 1, cartons: 1, pricePerBox: 13}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-013', payments: [{ date: '2026-01-13', amount: 306.8, method: 'מזומן', reference: '' }] },
      { id: 14, date: '2026-01-14', customerId: 14, items: [{productId: 1, cartons: 1, pricePerBox: 13}, {productId: 2, cartons: 1, pricePerBox: 19}, {productId: 3, cartons: 1, pricePerBox: 17}, {productId: 4, cartons: 1, pricePerBox: 18}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-014', payments: [{ date: '2026-01-14', amount: 1406.56, method: 'מזומן', reference: '' }] },
      { id: 15, date: '2026-01-13', customerId: 15, items: [{productId: 1, cartons: 2, pricePerBox: 13}, {productId: 2, cartons: 1, pricePerBox: 19}, {productId: 3, cartons: 2, pricePerBox: 17}], paymentStatus: 'שולם', paymentDueDate: '', notes: '', invoiceNumber: 'INV-015', payments: [{ date: '2026-01-13', amount: 1774.72, method: 'מזומן', reference: '' }] },
    ];

    const initialLeads = [
      { id: 1, name: 'גת גבס', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 2, name: 'מוטי פרץ', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 3, name: 'חומרי בניין עין קיניא', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 4, name: 'לזרי', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 5, name: 'ארז חומרי בניין ראשון', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 6, name: 'אליאב חומרי', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 7, name: 'אומנות הגימור', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 8, name: 'בתיה קרית מלאכי', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 9, name: 'אדירם חומרי בניין', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 10, name: 'עמינדב גדרה', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 11, name: 'סלמון גדרה', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 12, name: 'נתנאל נס ציונה', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 13, name: 'שלומי אלעד', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 14, name: 'לדארט', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 15, name: 'סלמן לב העיר רהט', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 16, name: 'אסביט פתח תקווה תמיר', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 17, name: 'אלפה טוס אשדוד', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 18, name: 'אבי אדר קרית גת', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 19, name: 'חסונה לוד סמי', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 20, name: 'מצפון כפר סבא', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
      { id: 21, name: 'כחלון קרית מלאכי', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' },
    ];

    const initialImports = [];
    const initialExpenses = [];
    const VAT = 0.18;
    const load = (k, d) => { try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : d; } catch { return d; } };
    const save = (k, d) => { try { localStorage.setItem(k, JSON.stringify(d)); } catch {} };
    const fmt = n => String.fromCharCode(8362) + (n || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });
    const getWeekDates = () => { const now = new Date(); const day = now.getDay(); const start = new Date(now); start.setDate(now.getDate() - day); const end = new Date(start); end.setDate(start.getDate() + 6); return { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] }; };

    function App() {
      const [tab, setTab] = useState('dashboard');
      const [products, setProducts] = useState(() => load('vnbP3', initialProducts));
      const [sales, setSales] = useState(() => load('vnbS3', initialSales));
      const [customers, setCustomers] = useState(() => load('vnbC3', initialCustomers));
      const [leads, setLeads] = useState(() => load('vnbL3', initialLeads));
      const [imports, setImports] = useState(() => load('vnbIm3', initialImports));
      const [expenses, setExpenses] = useState(() => load('vnbEx3', initialExpenses));
      const [targets, setTargets] = useState(() => load('vnbT3', { monthly: 50000 }));
      const [modal, setModal] = useState(null);
      const [editing, setEditing] = useState(null);
      const [viewCustomer, setViewCustomer] = useState(null);

      useEffect(() => { save('vnbP3', products); }, [products]);
      useEffect(() => { save('vnbS3', sales); }, [sales]);
      useEffect(() => { save('vnbC3', customers); }, [customers]);
      useEffect(() => { save('vnbL3', leads); }, [leads]);
      useEffect(() => { save('vnbIm3', imports); }, [imports]);
      useEffect(() => { save('vnbEx3', expenses); }, [expenses]);
      useEffect(() => { save('vnbT3', targets); }, [targets]);

      const calcSaleTotal = (sale, withVat = true) => {
        const base = (sale.items || []).reduce((sum, item) => {
          const p = products.find(x => x.id === item.productId);
          return sum + (item.cartons * (p?.boxesPerCarton || 0) * (item.pricePerBox || p?.pricePerBox || 0));
        }, 0);
        return withVat ? base * (1 + VAT) : base;
      };

      const getInventory = () => products.map(p => {
        const initial = p.initialStock || 0;
        const sold = sales.reduce((sum, s) => sum + ((s.items || []).find(i => i.productId === p.id)?.cartons || 0), 0);
        const incoming = imports.filter(i => i.status !== 'הגיע').reduce((sum, i) => sum + ((i.items || []).find(x => x.productId === p.id)?.cartons || 0), 0);
        const arrived = imports.filter(i => i.status === 'הגיע').reduce((sum, i) => sum + ((i.items || []).find(x => x.productId === p.id)?.cartons || 0), 0);
        const current = initial + arrived - sold;
        return { ...p, initial, sold, current, incoming, future: current + incoming, isLow: current <= p.minStock };
      });

      const inventory = getInventory();
      const lowStock = inventory.filter(p => p.isLow);
      const totalSalesNoVat = sales.reduce((s, x) => s + calcSaleTotal(x, false), 0);
      const totalSalesWithVat = sales.reduce((s, x) => s + calcSaleTotal(x, true), 0);
      const totalExpenses = expenses.reduce((s, x) => s + x.amount, 0);
      const week = getWeekDates();
      const weekLeads = leads.filter(l => l.nextFollowUp >= week.start && l.nextFollowUp <= week.end);
      const weekPayments = sales.filter(s => s.paymentStatus !== 'שולם' && s.paymentDueDate >= week.start && s.paymentDueDate <= week.end);
      const weekPaymentsTotal = weekPayments.reduce((sum, s) => calcSaleTotal(s) - (s.payments || []).reduce((p, x) => p + x.amount, 0), 0);
      const pendingSales = sales.filter(s => s.paymentStatus !== 'שולם');
      const totalPending = pendingSales.reduce((sum, s) => calcSaleTotal(s) - (s.payments || []).reduce((p, x) => p + x.amount, 0), 0);

      const exportToExcel = (type) => {
        let data = [], filename = '';
        if (type === 'sales') {
          filename = 'sales.xlsx';
          data = sales.map(s => {
            const c = customers.find(x => x.id === s.customerId);
            const noVat = calcSaleTotal(s, false), withVat = calcSaleTotal(s, true);
            const paid = (s.payments || []).reduce((p, x) => p + x.amount, 0);
            return { 'תאריך': s.date, 'חשבונית': s.invoiceNumber, 'לקוח': c?.name, 'לפני מעמ': Math.round(noVat), 'מעמ': Math.round(withVat - noVat), 'כולל מעמ': Math.round(withVat), 'שולם': Math.round(paid), 'יתרה': Math.round(withVat - paid), 'סטטוס': s.paymentStatus };
          });
        } else if (type === 'products') {
          filename = 'products.xlsx';
          data = products.map(p => {
            const soldCartons = sales.reduce((sum, s) => sum + ((s.items || []).find(i => i.productId === p.id)?.cartons || 0), 0);
            const revenue = sales.reduce((sum, s) => { const it = (s.items || []).find(i => i.productId === p.id); return it ? sum + it.cartons * p.boxesPerCarton * (it.pricePerBox || p.pricePerBox) : sum; }, 0);
            const cost = soldCartons * p.boxesPerCarton * p.costPerBox;
            return { 'מוצר': p.name, 'קרטונים': soldCartons, 'קופסאות': soldCartons * p.boxesPerCarton, 'הכנסות': Math.round(revenue), 'עלות': Math.round(cost), 'רווח': Math.round(revenue - cost) };
          });
        } else if (type === 'inventory') {
          filename = 'inventory.xlsx';
          data = inventory.map(p => ({ 'מוצר': p.name, 'התחלתי': p.initial, 'נמכר': p.sold, 'נוכחי': p.current, 'בדרך': p.incoming, 'עתידי': p.future }));
        }
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Data');
        XLSX.writeFile(wb, filename);
      };

      const Modal = ({ children, title, onClose }) => (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-slate-800 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center p-4 border-b border-slate-700">
              <h3 className="text-xl font-bold text-amber-400">{title}</h3>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">x</button>
            </div>
            <div className="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">{children}</div>
          </div>
        </div>
      );

      const EditProduct = () => {
        const [f, setF] = useState(editing || { name: '', boxesPerCarton: 20, screwsPerBox: 1000, pricePerBox: 0, costPerBox: 0, minStock: 5, initialStock: 0, notes: '' });
        const submit = () => {
          if (editing?.id) setProducts(products.map(p => p.id === editing.id ? { ...f, id: editing.id } : p));
          else setProducts([...products, { ...f, id: Math.max(0, ...products.map(p => p.id)) + 1 }]);
          setModal(null);
        };
        const del = () => { if (confirm('למחוק?')) { setProducts(products.filter(p => p.id !== editing.id)); setModal(null); } };
        return (
          <Modal title={editing?.id ? 'עריכת מוצר' : 'מוצר חדש'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <input placeholder="שם" value={f.name} onChange={e => setF({ ...f, name: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <div className="grid grid-cols-2 gap-2">
                <input type="number" placeholder="קופסאות/קרטון" value={f.boxesPerCarton} onChange={e => setF({ ...f, boxesPerCarton: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" placeholder="יחידות/קופסא" value={f.screwsPerBox} onChange={e => setF({ ...f, screwsPerBox: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <input type="number" step="0.5" placeholder="מחיר/קופסא" value={f.pricePerBox} onChange={e => setF({ ...f, pricePerBox: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" step="0.5" placeholder="עלות/קופסא" value={f.costPerBox} onChange={e => setF({ ...f, costPerBox: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <input type="number" placeholder="מלאי התחלתי" value={f.initialStock} onChange={e => setF({ ...f, initialStock: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" placeholder="התראת מינימום" value={f.minStock} onChange={e => setF({ ...f, minStock: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              <textarea placeholder="הערות" value={f.notes || ''} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">שמור</button>
              {editing?.id && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">מחק</button>}
            </div>
          </Modal>
        );
      };

      const EditCustomer = () => {
        const [f, setF] = useState(editing || { name: '', phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 3, notes: '', region: 'מרכז' });
        const submit = () => {
          if (editing?.id) setCustomers(customers.map(c => c.id === editing.id ? { ...f, id: editing.id } : c));
          else setCustomers([...customers, { ...f, id: Math.max(0, ...customers.map(c => c.id)) + 1 }]);
          setModal(null);
        };
        const del = () => { if (confirm('למחוק?')) { setCustomers(customers.filter(c => c.id !== editing.id)); setModal(null); } };
        return (
          <Modal title={editing?.id ? 'עריכת לקוח' : 'לקוח חדש'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <input placeholder="שם העסק" value={f.name} onChange={e => setF({ ...f, name: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="טלפון" value={f.phone} onChange={e => setF({ ...f, phone: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="איש קשר" value={f.contactPerson} onChange={e => setF({ ...f, contactPerson: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="כתובת" value={f.address} onChange={e => setF({ ...f, address: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <select value={f.paymentTerms} onChange={e => setF({ ...f, paymentTerms: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3">
                <option>מזומן</option><option>שוטף+30</option><option>שוטף+60</option><option>צק</option><option>ביט</option><option>העברה</option>
              </select>
              <textarea placeholder="הערות" value={f.notes || ''} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">שמור</button>
              {editing?.id && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">מחק</button>}
            </div>
          </Modal>
        );
      };

      const EditLead = () => {
        const [f, setF] = useState(editing || { name: '', status: 'חדש', phone: '', contact: '', notes: '', source: 'שטח', nextFollowUp: '' });
        const submit = () => {
          if (editing?.id) setLeads(leads.map(l => l.id === editing.id ? { ...f, id: editing.id } : l));
          else setLeads([...leads, { ...f, id: Math.max(0, ...leads.map(l => l.id)) + 1 }]);
          setModal(null);
        };
        const del = () => { if (confirm('למחוק?')) { setLeads(leads.filter(l => l.id !== editing.id)); setModal(null); } };
        const toCustomer = () => {
          setCustomers([...customers, { id: Math.max(0, ...customers.map(c => c.id)) + 1, name: f.name, phone: f.phone, contactPerson: f.contact, address: '', paymentTerms: 'מזומן', rating: 3, notes: f.notes, region: 'מרכז' }]);
          setLeads(leads.filter(l => l.id !== editing.id));
          setModal(null);
        };
        return (
          <Modal title={editing?.id ? 'עריכת ליד' : 'ליד חדש'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <input placeholder="שם העסק" value={f.name} onChange={e => setF({ ...f, name: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="איש קשר" value={f.contact} onChange={e => setF({ ...f, contact: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="טלפון" value={f.phone} onChange={e => setF({ ...f, phone: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <div className="grid grid-cols-2 gap-2">
                <select value={f.status} onChange={e => setF({ ...f, status: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option>חדש</option><option>פנייה ראשונה</option><option>פגישה</option><option>הצעת מחיר</option><option>לא רלוונטי</option>
                </select>
                <input type="date" placeholder="פולואפ" value={f.nextFollowUp} onChange={e => setF({ ...f, nextFollowUp: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              <textarea placeholder="הערות" value={f.notes || ''} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">שמור</button>
              {editing?.id && <><button onClick={toCustomer} className="w-full bg-emerald-500 text-white py-2 rounded-lg">הפוך ללקוח</button>
              <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">מחק</button></>}
            </div>
          </Modal>
        );
      };

      const EditSale = () => {
        const isNew = !editing?.id;
        const defaultItems = products.map(p => ({ productId: p.id, cartons: 0, pricePerBox: p.pricePerBox }));
        const [f, setF] = useState(editing || { date: new Date().toISOString().split('T')[0], customerId: '', items: defaultItems, paymentStatus: 'ממתין', paymentDueDate: '', notes: '', payments: [] });
        const [pay, setPay] = useState({ date: new Date().toISOString().split('T')[0], amount: 0, method: 'מזומן', reference: '' });
        const [showNewCustomer, setShowNewCustomer] = useState(false);
        const [newCustomerName, setNewCustomerName] = useState('');
        
        const items = f.items?.length ? f.items : defaultItems;
        const totalNoVat = items.reduce((s, item) => {
          const p = products.find(x => x.id === item.productId);
          return s + (item.cartons * (p?.boxesPerCarton || 0) * (item.pricePerBox || p?.pricePerBox || 0));
        }, 0);
        const total = totalNoVat * 1.18;
        const paid = (f.payments || []).reduce((s, p) => s + p.amount, 0);
        const remain = total - paid;

        const updateItem = (productId, field, value) => {
          const newItems = items.map(i => i.productId === productId ? { ...i, [field]: value } : i);
          setF({ ...f, items: newItems });
        };

        const addNewCustomer = () => {
          if (!newCustomerName.trim()) return;
          const newId = Math.max(0, ...customers.map(c => c.id)) + 1;
          setCustomers([...customers, { id: newId, name: newCustomerName.trim(), phone: '', address: '', contactPerson: '', paymentTerms: 'מזומן', rating: 3, notes: '', region: 'מרכז' }]);
          setF({ ...f, customerId: newId });
          setNewCustomerName('');
          setShowNewCustomer(false);
        };

        const addPay = () => {
          if (pay.amount <= 0) return;
          const pays = [...(f.payments || []), { ...pay }];
          const tot = pays.reduce((s, p) => s + p.amount, 0);
          setF({ ...f, payments: pays, paymentStatus: tot >= total ? 'שולם' : tot > 0 ? 'חלקי' : 'ממתין' });
          setPay({ date: new Date().toISOString().split('T')[0], amount: 0, method: 'מזומן', reference: '' });
        };
        
        const delPay = i => {
          const pays = f.payments.filter((_, idx) => idx !== i);
          const tot = pays.reduce((s, p) => s + p.amount, 0);
          setF({ ...f, payments: pays, paymentStatus: tot >= total ? 'שולם' : tot > 0 ? 'חלקי' : 'ממתין' });
        };
        
        const submit = () => {
          if (!f.customerId) return alert('בחר לקוח');
          const saleItems = items.filter(i => i.cartons > 0);
          if (saleItems.length === 0) return alert('הוסף מוצרים');
          if (isNew) setSales([...sales, { ...f, items: saleItems, id: Math.max(0, ...sales.map(s => s.id)) + 1, customerId: +f.customerId, invoiceNumber: 'INV-' + String(sales.length + 1).padStart(3, '0') }]);
          else setSales(sales.map(s => s.id === editing.id ? { ...f, items: saleItems, id: editing.id } : s));
          setModal(null);
        };
        
        const del = () => { if (confirm('למחוק?')) { setSales(sales.filter(s => s.id !== editing.id)); setModal(null); } };

        return (
          <Modal title={isNew ? 'מכירה חדשה' : 'עריכת מכירה'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-2">
                <input type="date" value={f.date} onChange={e => setF({ ...f, date: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3" />
                <select value={f.customerId} onChange={e => setF({ ...f, customerId: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option value="">בחר לקוח</option>
                  {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
              
              {!showNewCustomer ? (
                <button onClick={() => setShowNewCustomer(true)} className="text-amber-400 text-sm">+ הוסף לקוח חדש</button>
              ) : (
                <div className="bg-slate-700/50 p-3 rounded-lg space-y-2">
                  <input placeholder="שם הלקוח החדש" value={newCustomerName} onChange={e => setNewCustomerName(e.target.value)} className="w-full bg-slate-600 text-white rounded-lg p-2" />
                  <div className="flex gap-2">
                    <button onClick={addNewCustomer} className="flex-1 bg-emerald-500 text-white py-2 rounded text-sm">הוסף</button>
                    <button onClick={() => setShowNewCustomer(false)} className="flex-1 bg-slate-600 text-white py-2 rounded text-sm">ביטול</button>
                  </div>
                </div>
              )}

              <input type="date" placeholder="תאריך תשלום צפוי" value={f.paymentDueDate || ''} onChange={e => setF({ ...f, paymentDueDate: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              
              <div className="text-slate-300 text-sm font-bold">מוצרים:</div>
              {products.map(p => {
                const item = items.find(i => i.productId === p.id) || { cartons: 0, pricePerBox: p.pricePerBox };
                return (
                  <div key={p.id} className="bg-slate-700/50 p-2 rounded space-y-1">
                    <div className="flex justify-between items-center">
                      <span className="text-white text-sm">{p.name}</span>
                      <input type="number" min="0" placeholder="קרטונים" value={item.cartons || ''} onChange={e => updateItem(p.id, 'cartons', +e.target.value || 0)} className="w-20 bg-slate-600 text-white rounded p-2 text-center text-sm" />
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-slate-400 text-xs">מחיר/קופסא:</span>
                      <input type="number" step="0.5" value={item.pricePerBox || p.pricePerBox} onChange={e => updateItem(p.id, 'pricePerBox', +e.target.value || 0)} className="w-16 bg-slate-600 text-white rounded p-1 text-center text-xs" />
                    </div>
                  </div>
                );
              })}
              
              <div className="bg-amber-500/20 p-3 rounded-lg text-sm">
                <div className="flex justify-between"><span className="text-slate-300">לפני מעמ:</span><span className="text-white">{fmt(totalNoVat)}</span></div>
                <div className="flex justify-between"><span className="text-slate-300">מעמ 18%:</span><span className="text-white">{fmt(totalNoVat * 0.18)}</span></div>
                <div className="flex justify-between border-t border-slate-600 pt-1 mt-1"><span className="text-amber-400 font-bold">סהכ כולל מעמ:</span><span className="text-amber-400 font-bold">{fmt(total)}</span></div>
                <div className="flex justify-between mt-2"><span className="text-emerald-400">שולם:</span><span className="text-emerald-400">{fmt(paid)}</span></div>
                <div className="flex justify-between"><span className="text-red-400">יתרה:</span><span className="text-red-400 font-bold">{fmt(remain)}</span></div>
              </div>
              
              {f.payments?.length > 0 && <div className="space-y-1">{f.payments.map((p, i) => (
                <div key={i} className="flex justify-between items-center bg-slate-700/30 p-2 rounded text-sm">
                  <span className="text-white">{fmt(p.amount)} - {p.method} - {p.date}</span>
                  <button onClick={() => delPay(i)} className="text-red-400">X</button>
                </div>
              ))}</div>}
              
              {remain > 0 && <div className="bg-slate-700/30 p-3 rounded space-y-2">
                <div className="text-slate-300 text-sm font-bold">הוסף תשלום</div>
                <div className="grid grid-cols-2 gap-2">
                  <input type="date" value={pay.date} onChange={e => setPay({ ...pay, date: e.target.value })} className="bg-slate-600 text-white rounded p-2 text-sm" />
                  <input type="number" placeholder="סכום" value={pay.amount || ''} onChange={e => setPay({ ...pay, amount: +e.target.value || 0 })} className="bg-slate-600 text-white rounded p-2 text-sm" />
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <select value={pay.method} onChange={e => setPay({ ...pay, method: e.target.value })} className="bg-slate-600 text-white rounded p-2 text-sm">
                    <option>מזומן</option><option>אשראי</option><option>צק</option><option>העברה</option><option>ביט</option>
                  </select>
                  <input placeholder="אסמכתא" value={pay.reference} onChange={e => setPay({ ...pay, reference: e.target.value })} className="bg-slate-600 text-white rounded p-2 text-sm" />
                </div>
                <button onClick={addPay} className="w-full bg-emerald-500 text-white py-2 rounded font-bold text-sm">+ הוסף תשלום</button>
                <button onClick={() => setPay({ ...pay, amount: Math.round(remain) })} className="text-amber-400 text-xs">מלא יתרה ({fmt(remain)})</button>
              </div>}
              
              <textarea placeholder="הערות" value={f.notes || ''} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">שמור</button>
              {!isNew && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">מחק</button>}
            </div>
          </Modal>
        );
      };

      const EditExpense = () => {
        const isNew = !editing?.id;
        const [f, setF] = useState(editing || { date: new Date().toISOString().split('T')[0], category: 'דלק', amount: 0, description: '', notes: '' });
        const submit = () => {
          if (isNew) setExpenses([...expenses, { ...f, id: Math.max(0, ...expenses.map(e => e.id)) + 1 }]);
          else setExpenses(expenses.map(e => e.id === editing.id ? { ...f, id: editing.id } : e));
          setModal(null);
        };
        const del = () => { if (confirm('למחוק?')) { setExpenses(expenses.filter(e => e.id !== editing.id)); setModal(null); } };
        return (
          <Modal title={isNew ? 'הוצאה חדשה' : 'עריכת הוצאה'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-2">
                <input type="date" value={f.date} onChange={e => setF({ ...f, date: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3" />
                <select value={f.category} onChange={e => setF({ ...f, category: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option>דלק</option><option>הובלות</option><option>אחסנה</option><option>שינוע</option><option>מכס</option><option>ביטוח</option><option>אחר</option>
                </select>
              </div>
              <input type="number" placeholder="סכום" value={f.amount} onChange={e => setF({ ...f, amount: +e.target.value || 0 })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="תיאור" value={f.description} onChange={e => setF({ ...f, description: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <textarea placeholder="הערות" value={f.notes || ''} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">שמור</button>
              {!isNew && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">מחק</button>}
            </div>
          </Modal>
        );
      };

      const CustomerDetails = () => {
        const c = viewCustomer;
        const customerSales = sales.filter(s => s.customerId === c.id);
        const totalNoVat = customerSales.reduce((sum, s) => sum + calcSaleTotal(s, false), 0);
        const totalWithVat = customerSales.reduce((sum, s) => sum + calcSaleTotal(s, true), 0);
        const productsSold = {};
        customerSales.forEach(s => (s.items || []).forEach(item => { productsSold[item.productId] = (productsSold[item.productId] || 0) + item.cartons; }));
        return (
          <Modal title={c.name} onClose={() => setViewCustomer(null)}>
            <div className="space-y-4">
              <div className="bg-slate-700/50 p-3 rounded-lg text-sm">
                <div className="text-slate-400">טלפון: <span className="text-white">{c.phone || '-'}</span></div>
                <div className="text-slate-400">כתובת: <span className="text-white">{c.address || '-'}</span></div>
                <div className="text-slate-400">תנאי תשלום: <span className="text-white">{c.paymentTerms}</span></div>
              </div>
              <div className="bg-amber-500/20 p-3 rounded-lg">
                <div className="text-slate-300 text-sm">לפני מעמ: {fmt(totalNoVat)}</div>
                <div className="text-amber-400 font-bold text-lg">סהכ כולל מעמ: {fmt(totalWithVat)}</div>
                <div className="text-slate-300 text-sm">{customerSales.length} הזמנות</div>
              </div>
              <div className="text-slate-300 font-bold">מוצרים שנרכשו:</div>
              {Object.entries(productsSold).map(([pid, cartons]) => {
                const p = products.find(x => x.id === +pid);
                return <div key={pid} className="flex justify-between bg-slate-700/30 p-2 rounded text-sm">
                  <span className="text-white">{p?.name}</span>
                  <span className="text-amber-400">{cartons} קרטונים</span>
                </div>;
              })}
              <div className="text-slate-300 font-bold mt-4">היסטוריית מכירות:</div>
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {customerSales.map(s => (
                  <div key={s.id} className="bg-slate-700/30 p-2 rounded text-sm">
                    <div className="flex justify-between">
                      <span className="text-slate-400">{s.date}</span>
                      <div className="text-left">
                        <div className="text-slate-400 text-xs">לפני מעמ: {fmt(calcSaleTotal(s, false))}</div>
                        <div className="text-amber-400 font-bold">כולל מעמ: {fmt(calcSaleTotal(s, true))}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </Modal>
        );
      };

      const Dashboard = () => (
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-amber-500/20 rounded-xl p-4 border border-amber-500/30">
              <div className="text-amber-400 text-xs">סהכ מכירות</div>
              <div className="text-xl font-bold text-white">{fmt(totalSalesWithVat)}</div>
              <div className="text-slate-400 text-xs">לפני מעמ: {fmt(totalSalesNoVat)}</div>
            </div>
            <div className="bg-red-500/20 rounded-xl p-4 border border-red-500/30">
              <div className="text-red-400 text-xs">ממתין לתשלום</div>
              <div className="text-xl font-bold text-white">{fmt(totalPending)}</div>
              <div className="text-slate-400 text-xs">{pendingSales.length} עסקאות</div>
            </div>
          </div>

          {weekPayments.length > 0 && (
            <div className="bg-blue-500/20 rounded-xl p-4 border border-blue-500/30">
              <h3 className="text-blue-400 font-bold mb-2">תשלומים צפויים השבוע</h3>
              <div className="text-xl font-bold text-white mb-2">{fmt(weekPaymentsTotal)}</div>
              {weekPayments.map(s => {
                const c = customers.find(x => x.id === s.customerId);
                return <div key={s.id} className="flex justify-between text-sm bg-slate-700/30 p-2 rounded mb-1">
                  <span className="text-white">{c?.name}</span>
                  <span className="text-blue-400">{s.paymentDueDate}</span>
                </div>;
              })}
            </div>
          )}

          {weekLeads.length > 0 && (
            <div className="bg-purple-500/20 rounded-xl p-4 border border-purple-500/30">
              <h3 className="text-purple-400 font-bold mb-2">פולואפ השבוע ({weekLeads.length})</h3>
              {weekLeads.map(l => (
                <div key={l.id} onClick={() => { setEditing(l); setModal('lead'); }} className="flex justify-between bg-slate-700/30 p-2 rounded mb-1 cursor-pointer">
                  <span className="text-white text-sm">{l.name}</span>
                  <span className="text-purple-400 text-xs">{l.nextFollowUp}</span>
                </div>
              ))}
            </div>
          )}

          {lowStock.length > 0 && (
            <div className="bg-red-500/20 rounded-xl p-4 border border-red-500/30">
              <h3 className="text-red-400 font-bold mb-2">מלאי נמוך</h3>
              {lowStock.map(p => (
                <div key={p.id} className="flex justify-between text-sm bg-slate-700/30 p-2 rounded mb-1">
                  <span className="text-white">{p.name}</span>
                  <span className="text-red-400">{p.current} קרטונים</span>
                </div>
              ))}
            </div>
          )}

          <div className="grid grid-cols-2 gap-2">
            <button onClick={() => { setEditing(null); setModal('sale'); }} className="bg-amber-500 text-slate-900 font-bold py-3 rounded-xl">+ מכירה</button>
            <button onClick={() => { setEditing(null); setModal('customer'); }} className="bg-slate-700 text-white font-bold py-3 rounded-xl">+ לקוח</button>
          </div>

          <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
            <h3 className="text-white font-bold mb-3">מכירות אחרונות</h3>
            {[...sales].reverse().slice(0, 5).map(s => {
              const c = customers.find(x => x.id === s.customerId);
              return <div key={s.id} onClick={() => { setEditing(s); setModal('sale'); }} className="flex justify-between bg-slate-700/30 p-2 rounded-lg mb-2 cursor-pointer">
                <div><div className="text-white text-sm">{c?.name}</div><div className="text-slate-400 text-xs">{s.date}</div></div>
                <div className="text-left">
                  <div className="text-slate-400 text-xs">{fmt(calcSaleTotal(s, false))}</div>
                  <div className="text-amber-400 font-bold">{fmt(calcSaleTotal(s))}</div>
                </div>
              </div>;
            })}
          </div>
        </div>
      );
="flex-1 cursor-pointer" onClick={() => setViewCustomer(c)}>
                    <div className="text-white font-bold">{c.name}</div>
                    <div className="text-slate-400 text-xs">{c.phone || '-'} - {c.address || '-'}</div>
                    <div className="text-slate-500 text-xs">{customerSales.length} הזמנות</div>
                  </div>
                  <div className="text-left">
                    <div className="text-amber-400 font-bold">{fmt(total)}</div>
                    <button onClick={() => { setEditing(c); setModal('customer'); }} className="text-slate-400 text-xs">עריכה</button>
                  </div>
                </div>
              </div>;
            })}
          </div>
        </div>
      );

      const Leads = () => {
        const sorted = [...leads].sort((a, b) => {
          if (!a.nextFollowUp) return 1;
          if (!b.nextFollowUp) return -1;
          return a.nextFollowUp.localeCompare(b.nextFollowUp);
        });
        const colors = { 'חדש': 'bg-blue-500/20 text-blue-400', 'פנייה ראשונה': 'bg-yellow-500/20 text-yellow-400', 'פגישה': 'bg-purple-500/20 text-purple-400', 'הצעת מחיר': 'bg-orange-500/20 text-orange-400', 'לא רלוונטי': 'bg-slate-500/20 text-slate-400' };
        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-white">לידים ({leads.length})</h2>
              <button onClick={() => { setEditing(null); setModal('lead'); }} className="bg-amber-500 text-slate-900 px-3 py-1.5 rounded-lg font-bold text-sm">+ ליד</button>
            </div>
            <div className="space-y-2 max-h-[70vh] overflow-y-auto">
              {sorted.map(l => (
                <div key={l.id} onClick={() => { setEditing(l); setModal('lead'); }} className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 cursor-pointer">
                  <div className="flex justify-between">
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="text-white font-medium">{l.name}</span>
                        <span className={'px-2 py-0.5 rounded-full text-xs ' + (colors[l.status] || '')}>{l.status}</span>
                      </div>
                      {l.phone && <div className="text-slate-400 text-xs">{l.phone}</div>}
                    </div>
                    {l.nextFollowUp && <div className="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">{l.nextFollowUp}</div>}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      };

      const Expenses = () => {
        const byCategory = expenses.reduce((acc, e) => { acc[e.category] = (acc[e.category] || 0) + e.amount; return acc; }, {});
        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-white">הוצאות</h2>
              <button onClick={() => { setEditing(null); setModal('expense'); }} className="bg-amber-500 text-slate-900 px-3 py-1.5 rounded-lg font-bold text-sm">+ הוצאה</button>
            </div>
            <div className="bg-red-500/20 rounded-xl p-4 border border-red-500/30">
              <div className="text-red-400 text-xs">סהכ הוצאות</div>
              <div className="text-2xl font-bold text-white">{fmt(totalExpenses)}</div>
            </div>
            {Object.keys(byCategory).length > 0 && (
              <div className="grid grid-cols-2 gap-2">
                {Object.entries(byCategory).map(([cat, amount]) => (
                  <div key={cat} className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                    <div className="text-slate-400 text-xs">{cat}</div>
                    <div className="text-white font-bold">{fmt(amount)}</div>
                  </div>
                ))}
              </div>
            )}
            <div className="space-y-2 max-h-[50vh] overflow-y-auto">
              {expenses.length === 0 ? <div className="text-slate-500 text-center py-4">אין הוצאות</div> : [...expenses].reverse().map(e => (
                <div key={e.id} onClick={() => { setEditing(e); setModal('expense'); }} className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 cursor-pointer">
                  <div className="flex justify-between">
                    <div>
                      <div className="text-white font-medium">{e.description || e.category}</div>
                      <div className="text-slate-400 text-xs">{e.date} - {e.category}</div>
                    </div>
                    <div className="text-red-400 font-bold">{fmt(e.amount)}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      };

      const Settings = () => {
        const exp = () => {
          const data = { products, sales, customers, leads, imports, expenses, targets };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'vnb-backup.json'; a.click();
        };
        const imp = e => {
          const file = e.target.files[0];
          if (file) {
            const r = new FileReader();
            r.onload = ev => {
              try {
                const d = JSON.parse(ev.target.result);
                if (confirm('לטעון גיבוי?')) {
                  if (d.products) setProducts(d.products);
                  if (d.sales) setSales(d.sales);
                  if (d.customers) setCustomers(d.customers);
                  if (d.leads) setLeads(d.leads);
                  if (d.imports) setImports(d.imports);
                  if (d.expenses) setExpenses(d.expenses);
                  if (d.targets) setTargets(d.targets);
                  alert('נטען!');
                }
              } catch { alert('שגיאה'); }
            };
            r.readAsText(file);
          }
        };
        const reset = () => { if (confirm('למחוק הכל?')) { localStorage.clear(); location.reload(); } };
        return (
          <div className="space-y-4">
            <h2 className="text-lg font-bold text-white">הגדרות</h2>
            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
              <h3 className="text-amber-400 font-bold mb-3">ייצוא Excel</h3>
              <div className="grid grid-cols-2 gap-2">
                <button onClick={() => exportToExcel('sales')} className="bg-emerald-500 text-white py-2 rounded-lg text-sm">מכירות</button>
                <button onClick={() => exportToExcel('products')} className="bg-blue-500 text-white py-2 rounded-lg text-sm">לפי מוצר</button>
                <button onClick={() => exportToExcel('inventory')} className="bg-purple-500 text-white py-2 rounded-lg text-sm">מלאי</button>
              </div>
            </div>
            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
              <h3 className="text-amber-400 font-bold mb-3">גיבוי</h3>
              <button onClick={exp} className="w-full bg-emerald-500 text-white py-3 rounded-lg font-bold mb-2">הורד גיבוי</button>
              <label className="w-full bg-blue-500 text-white py-3 rounded-lg font-bold flex items-center justify-center cursor-pointer">טען גיבוי<input type="file" accept=".json" onChange={imp} className="hidden" /></label>
            </div>
            <div className="bg-red-500/10 rounded-xl p-4 border border-red-500/30">
              <button onClick={reset} className="w-full bg-red-500 text-white py-3 rounded-lg font-bold">מחק הכל</button>
            </div>
          </div>
        );
      };

      const tabs = [
        { id: 'dashboard', icon: '🏠', label: 'ראשי' },
        { id: 'inventory', icon: '📦', label: 'מלאי' },
        { id: 'sales', icon: '💰', label: 'מכירות' },
        { id: 'customers', icon: '👥', label: 'לקוחות' },
        { id: 'leads', icon: '🎯', label: 'לידים' },
        { id: 'expenses', icon: '💸', label: 'הוצאות' },
        { id: 'settings', icon: '⚙️', label: 'הגדרות' },
      ];

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900" dir="rtl">
          <header className="bg-slate-800/90 backdrop-blur sticky top-0 z-40 border-b border-slate-700">
            <div className="max-w-lg mx-auto px-4 py-3 flex justify-between items-center">
              <div><h1 className="text-xl font-bold text-amber-400">VNB</h1><p className="text-xs text-slate-400">גרינברג נירים</p></div>
              <div className="text-left">
                <div className="text-amber-400 font-bold">{fmt(totalSalesWithVat)}</div>
                <div className="text-slate-400 text-xs">כולל מעמ</div>
              </div>
            </div>
          </header>
          
          <main className="max-w-lg mx-auto px-4 py-4 pb-24">
            {tab === 'dashboard' && <Dashboard />}
            {tab === 'inventory' && <Inventory />}
            {tab === 'sales' && <Sales />}
            {tab === 'customers' && <Customers />}
            {tab === 'leads' && <Leads />}
            {tab === 'expenses' && <Expenses />}
            {tab === 'settings' && <Settings />}
          </main>
          
          <nav className="fixed bottom-0 left-0 right-0 bg-slate-800/95 backdrop-blur border-t border-slate-700">
            <div className="max-w-lg mx-auto px-1">
              <div className="flex justify-around">
                {tabs.map(t => (
                  <button key={t.id} onClick={() => setTab(t.id)} className={'flex flex-col items-center py-2 px-2 rounded-lg ' + (tab === t.id ? 'bg-amber-500/20 text-amber-400' : 'text-slate-400')}>
                    <span className="text-lg">{t.icon}</span><span className="text-[10px]">{t.label}</span>
                  </button>
                ))}
              </div>
            </div>
          </nav>
          
          {modal === 'sale' && <EditSale />}
          {modal === 'customer' && <EditCustomer />}
          {modal === 'lead' && <EditLead />}
          {modal === 'product' && <EditProduct />}
          {modal === 'expense' && <EditExpense />}
          {viewCustomer && <CustomerDetails />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
