<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VNB - ××¢×¨×›×ª × ×™×”×•×œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const initialProducts = [
      { id: 1, name: '×‘×•×¨×’ 35*2.5', boxesPerCarton: 20, screwsPerBox: 1000, pricePerBox: 13, costPerBox: 6.5, minStock: 10 },
      { id: 2, name: '×‘×•×¨×’ 35*3.5', boxesPerCarton: 16, screwsPerBox: 1000, pricePerBox: 19, costPerBox: 9.5, minStock: 10 },
      { id: 3, name: '×‘×•×¨×’ ×¤×—×¤×— 4.2*13', boxesPerCarton: 20, screwsPerBox: 1000, pricePerBox: 17, costPerBox: 8.5, minStock: 10 },
      { id: 4, name: '×‘×•×¨×’ 4.8*3.5', boxesPerCarton: 16, screwsPerBox: 500, pricePerBox: 18, costPerBox: 9, minStock: 10 },
    ];

    const initialInventory = [
      { productId: 1, cartons: 68 },
      { productId: 2, cartons: 26 },
      { productId: 3, cartons: 42 },
      { productId: 4, cartons: 72 },
    ];

    const initialCustomers = [
      { id: 1, name: '× ×•×¨ ×¨×—××™×', phone: '050-1234567', address: '×ª×œ ××‘×™×‘', contactPerson: '× ×•×¨', paymentTerms: '××–×•××Ÿ', rating: 5, notes: '', region: '××¨×›×–' },
      { id: 2, name: '×¡×™××Ÿ ×˜×•×‘ ×—×•××¨×™ ×‘× ×™×™×Ÿ', phone: '054-5555555', address: '××©×“×•×“', contactPerson: '×•×™×§×˜×•×¨', paymentTerms: '××–×•××Ÿ', rating: 5, notes: '', region: '×“×¨×•×' },
      { id: 3, name: '×¢×•×œ× ×”×©×œ×“', phone: '054-4444444', address: '×ª×œ ××‘×™×‘', contactPerson: '', paymentTerms: '××–×•××Ÿ', rating: 5, notes: '', region: '××¨×›×–' },
    ];

    const initialSales = [
      { id: 1, date: '2024-12-27', customerId: 1, products: { 1: 2, 2: 2, 3: 1, 4: 1 }, paymentStatus: '×©×•×œ×', notes: '', invoiceNumber: 'INV-001', payments: [{ date: '2024-12-27', amount: 1732, method: '××–×•××Ÿ', reference: '' }] },
      { id: 2, date: '2025-01-07', customerId: 3, products: { 1: 0, 2: 2, 3: 0, 4: 36 }, paymentStatus: '×©×•×œ×', notes: '', invoiceNumber: 'INV-002', payments: [{ date: '2025-01-07', amount: 12951, method: '××–×•××Ÿ', reference: '' }] },
    ];

    const initialLeads = [
      { id: 1, name: '×’×ª ×’×‘×¡', status: '×—×“×©', phone: '', contact: '', notes: '', source: '×”××œ×¦×”', nextFollowUp: '' },
      { id: 2, name: '××¨×– ×—×•××¨×™ ×‘× ×™×™×Ÿ', status: '×”×¦×¢×ª ××—×™×¨', phone: '', contact: '', notes: '', source: '×©×˜×—', nextFollowUp: '2025-01-18' },
    ];

    const initialImports = [
      { id: 1, date: '2024-11-15', supplier: 'Ningbo Fasteners', items: [{ productId: 1, cartons: 100 }], productCost: 15000, shipping: 2500, customs: 1800, insurance: 400, status: '×”×’×™×¢', notes: '' },
    ];

    const VAT = 0.18;
    const load = (k, d) => { try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : d; } catch { return d; } };
    const save = (k, d) => { try { localStorage.setItem(k, JSON.stringify(d)); } catch {} };
    const fmt = n => 'â‚ª' + (n || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });

    function App() {
      const [tab, setTab] = useState('dashboard');
      const [products, setProducts] = useState(() => load('vnbP', initialProducts));
      const [inventory, setInventory] = useState(() => load('vnbI', initialInventory));
      const [sales, setSales] = useState(() => load('vnbS', initialSales));
      const [customers, setCustomers] = useState(() => load('vnbC', initialCustomers));
      const [leads, setLeads] = useState(() => load('vnbL', initialLeads));
      const [imports, setImports] = useState(() => load('vnbIm', initialImports));
      const [targets, setTargets] = useState(() => load('vnbT', { monthly: 50000 }));
      const [modal, setModal] = useState(null);
      const [editing, setEditing] = useState(null);

      useEffect(() => { save('vnbP', products); }, [products]);
      useEffect(() => { save('vnbI', inventory); }, [inventory]);
      useEffect(() => { save('vnbS', sales); }, [sales]);
      useEffect(() => { save('vnbC', customers); }, [customers]);
      useEffect(() => { save('vnbL', leads); }, [leads]);
      useEffect(() => { save('vnbIm', imports); }, [imports]);
      useEffect(() => { save('vnbT', targets); }, [targets]);

      const calcTotal = (s, vat = true) => {
        const base = products.reduce((sum, p) => sum + ((s.products?.[p.id] || 0) * p.boxesPerCarton * p.pricePerBox), 0);
        return vat ? base * (1 + VAT) : base;
      };

      const invBalance = products.map(p => {
        const init = inventory.find(i => i.productId === p.id)?.cartons || 0;
        const sold = sales.reduce((sum, s) => sum + (s.products?.[p.id] || 0), 0);
        return { ...p, init, sold, remain: init - sold };
      });

      const totalSales = sales.reduce((s, x) => s + calcTotal(x), 0);
      const pending = sales.filter(s => s.paymentStatus !== '×©×•×œ×').reduce((sum, s) => sum + calcTotal(s), 0);

      const Modal = ({ children, title, onClose }) => (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-slate-800 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center p-4 border-b border-slate-700">
              <h3 className="text-xl font-bold text-amber-400">{title}</h3>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>
            <div className="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">{children}</div>
          </div>
        </div>
      );

      const EditProduct = () => {
        const [f, setF] = useState(editing || { name: '', boxesPerCarton: 20, screwsPerBox: 1000, pricePerBox: 0, costPerBox: 0, minStock: 10 });
        const inv = inventory.find(i => i.productId === editing?.id) || { cartons: 0 };
        const [cart, setCart] = useState(inv.cartons);
        const submit = () => {
          if (editing) {
            setProducts(products.map(p => p.id === editing.id ? { ...f, id: editing.id } : p));
            setInventory(inventory.map(i => i.productId === editing.id ? { ...i, cartons: cart } : i));
          } else {
            const id = Math.max(0, ...products.map(p => p.id)) + 1;
            setProducts([...products, { ...f, id }]);
            setInventory([...inventory, { productId: id, cartons: cart }]);
          }
          setModal(null);
        };
        const del = () => { if (window.confirm('×œ××—×•×§?')) { setProducts(products.filter(p => p.id !== editing.id)); setModal(null); } };
        return (
          <Modal title={editing ? '×¢×¨×™×›×ª ××•×¦×¨' : '××•×¦×¨ ×—×“×©'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <input placeholder="×©× ×”××•×¦×¨" value={f.name} onChange={e => setF({ ...f, name: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <div className="grid grid-cols-2 gap-2">
                <input type="number" placeholder="×§×•×¤×¡××•×ª/×§×¨×˜×•×Ÿ" value={f.boxesPerCarton} onChange={e => setF({ ...f, boxesPerCarton: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" placeholder="×‘×¨×’×™×/×§×•×¤×¡×" value={f.screwsPerBox} onChange={e => setF({ ...f, screwsPerBox: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <input type="number" step="0.5" placeholder="××—×™×¨ ××›×™×¨×”" value={f.pricePerBox} onChange={e => setF({ ...f, pricePerBox: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" step="0.5" placeholder="×¢×œ×•×ª" value={f.costPerBox} onChange={e => setF({ ...f, costPerBox: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <input type="number" placeholder="×”×ª×¨××ª ××œ××™" value={f.minStock} onChange={e => setF({ ...f, minStock: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" placeholder="×§×¨×˜×•× ×™× ×‘××œ××™" value={cart} onChange={e => setCart(+e.target.value || 0)} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              {f.pricePerBox > 0 && f.costPerBox > 0 && <div className="bg-emerald-500/20 p-2 rounded text-center text-emerald-400">×¨×•×•×—: {(((f.pricePerBox - f.costPerBox) / f.costPerBox) * 100).toFixed(0)}%</div>}
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">×©××•×¨</button>
              {editing && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">××—×§</button>}
            </div>
          </Modal>
        );
      };

      const EditCustomer = () => {
        const [f, setF] = useState(editing || { name: '', phone: '', address: '', contactPerson: '', paymentTerms: '××–×•××Ÿ', rating: 3, notes: '', region: '××¨×›×–' });
        const submit = () => {
          if (editing) setCustomers(customers.map(c => c.id === editing.id ? { ...f, id: editing.id } : c));
          else setCustomers([...customers, { ...f, id: Math.max(0, ...customers.map(c => c.id)) + 1 }]);
          setModal(null);
        };
        const del = () => { if (window.confirm('×œ××—×•×§?')) { setCustomers(customers.filter(c => c.id !== editing.id)); setModal(null); } };
        return (
          <Modal title={editing ? '×¢×¨×™×›×ª ×œ×§×•×—' : '×œ×§×•×— ×—×“×©'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <input placeholder="×©× ×”×¢×¡×§" value={f.name} onChange={e => setF({ ...f, name: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="×˜×œ×¤×•×Ÿ" value={f.phone} onChange={e => setF({ ...f, phone: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="××™×© ×§×©×¨" value={f.contactPerson} onChange={e => setF({ ...f, contactPerson: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="×›×ª×•×‘×ª" value={f.address} onChange={e => setF({ ...f, address: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <div className="grid grid-cols-2 gap-2">
                <select value={f.region} onChange={e => setF({ ...f, region: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option>××¨×›×–</option><option>×“×¨×•×</option><option>×©×¨×•×Ÿ</option><option>×™×¨×•×©×œ×™×</option><option>×¦×¤×•×Ÿ</option>
                </select>
                <select value={f.paymentTerms} onChange={e => setF({ ...f, paymentTerms: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option>××–×•××Ÿ</option><option>×©×•×˜×£+30</option><option>×©×•×˜×£+60</option><option>×¦'×§</option>
                </select>
              </div>
              <div><span className="text-slate-300 text-sm">×“×™×¨×•×’:</span>
                <div className="flex gap-1 mt-1">{[1,2,3,4,5].map(n => <button key={n} onClick={() => setF({ ...f, rating: n })} className={`text-2xl ${n <= f.rating ? 'text-amber-400' : 'text-slate-600'}`}>â­</button>)}</div>
              </div>
              <textarea placeholder="×”×¢×¨×•×ª" value={f.notes} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">×©××•×¨</button>
              {editing && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">××—×§</button>}
            </div>
          </Modal>
        );
      };

      const EditLead = () => {
        const [f, setF] = useState(editing || { name: '', status: '×—×“×©', phone: '', contact: '', notes: '', source: '×©×˜×—', nextFollowUp: '' });
        const submit = () => {
          if (editing) setLeads(leads.map(l => l.id === editing.id ? { ...f, id: editing.id } : l));
          else setLeads([...leads, { ...f, id: Math.max(0, ...leads.map(l => l.id)) + 1 }]);
          setModal(null);
        };
        const del = () => { if (window.confirm('×œ××—×•×§?')) { setLeads(leads.filter(l => l.id !== editing.id)); setModal(null); } };
        const toCustomer = () => {
          setCustomers([...customers, { id: Math.max(0, ...customers.map(c => c.id)) + 1, name: f.name, phone: f.phone, contactPerson: f.contact, address: '', paymentTerms: '××–×•××Ÿ', rating: 3, notes: f.notes, region: '××¨×›×–' }]);
          setLeads(leads.filter(l => l.id !== editing.id));
          setModal(null);
        };
        return (
          <Modal title={editing ? '×¢×¨×™×›×ª ×œ×™×“' : '×œ×™×“ ×—×“×©'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <input placeholder="×©× ×”×¢×¡×§" value={f.name} onChange={e => setF({ ...f, name: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="××™×© ×§×©×¨" value={f.contact} onChange={e => setF({ ...f, contact: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <input placeholder="×˜×œ×¤×•×Ÿ" value={f.phone} onChange={e => setF({ ...f, phone: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <div className="grid grid-cols-2 gap-2">
                <select value={f.status} onChange={e => setF({ ...f, status: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option>×—×“×©</option><option>×¤× ×™×™×” ×¨××©×•× ×”</option><option>×¤×’×™×©×”</option><option>×”×¦×¢×ª ××—×™×¨</option><option>×œ× ×¨×œ×•×•× ×˜×™</option>
                </select>
                <select value={f.source} onChange={e => setF({ ...f, source: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option>×©×˜×—</option><option>×”××œ×¦×”</option><option>××™× ×˜×¨× ×˜</option><option>××—×¨</option>
                </select>
              </div>
              <div><span className="text-slate-300 text-sm">×¤×•×œ×•××¤:</span>
                <input type="date" value={f.nextFollowUp} onChange={e => setF({ ...f, nextFollowUp: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3 mt-1" />
              </div>
              <textarea placeholder="×”×¢×¨×•×ª" value={f.notes} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">×©××•×¨</button>
              {editing && <><button onClick={toCustomer} className="w-full bg-emerald-500 text-white py-2 rounded-lg">ğŸ‰ ×”×¤×•×š ×œ×œ×§×•×—</button>
              <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">××—×§</button></>}
            </div>
          </Modal>
        );
      };

      const EditSale = () => {
        const isNew = !editing;
        const [f, setF] = useState(editing || { date: new Date().toISOString().split('T')[0], customerId: '', products: {}, paymentStatus: '×××ª×™×Ÿ', notes: '', payments: [] });
        const [pay, setPay] = useState({ date: new Date().toISOString().split('T')[0], amount: 0, method: '××–×•××Ÿ', reference: '' });
        const total = products.reduce((s, p) => s + ((f.products?.[p.id] || 0) * p.boxesPerCarton * p.pricePerBox * 1.18), 0);
        const paid = (f.payments || []).reduce((s, p) => s + p.amount, 0);
        const remain = total - paid;
        const addPay = () => {
          if (pay.amount <= 0) return;
          const pays = [...(f.payments || []), { ...pay }];
          const tot = pays.reduce((s, p) => s + p.amount, 0);
          setF({ ...f, payments: pays, paymentStatus: tot >= total ? '×©×•×œ×' : tot > 0 ? '×—×œ×§×™' : '×××ª×™×Ÿ' });
          setPay({ date: new Date().toISOString().split('T')[0], amount: 0, method: '××–×•××Ÿ', reference: '' });
        };
        const delPay = i => {
          const pays = f.payments.filter((_, idx) => idx !== i);
          const tot = pays.reduce((s, p) => s + p.amount, 0);
          setF({ ...f, payments: pays, paymentStatus: tot >= total ? '×©×•×œ×' : tot > 0 ? '×—×œ×§×™' : '×××ª×™×Ÿ' });
        };
        const submit = () => {
          if (!f.customerId) return alert('×‘×—×¨ ×œ×§×•×—');
          if (isNew) setSales([...sales, { ...f, id: Math.max(0, ...sales.map(s => s.id)) + 1, customerId: +f.customerId, invoiceNumber: `INV-${String(sales.length + 1).padStart(3, '0')}` }]);
          else setSales(sales.map(s => s.id === editing.id ? { ...f, id: editing.id } : s));
          setModal(null);
        };
        const del = () => { if (window.confirm('×œ××—×•×§?')) { setSales(sales.filter(s => s.id !== editing.id)); setModal(null); } };
        return (
          <Modal title={isNew ? '××›×™×¨×” ×—×“×©×”' : '×¢×¨×™×›×ª ××›×™×¨×”'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-2">
                <input type="date" value={f.date} onChange={e => setF({ ...f, date: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3" />
                <select value={f.customerId} onChange={e => setF({ ...f, customerId: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option value="">×‘×—×¨ ×œ×§×•×—</option>
                  {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
              <div className="text-slate-300 text-sm">×§×¨×˜×•× ×™×:</div>
              {products.map(p => (
                <div key={p.id} className="flex justify-between items-center bg-slate-700/50 p-2 rounded">
                  <span className="text-white text-sm">{p.name}</span>
                  <input type="number" min="0" value={f.products?.[p.id] || 0} onChange={e => setF({ ...f, products: { ...f.products, [p.id]: +e.target.value || 0 } })} className="w-16 bg-slate-600 text-white rounded p-2 text-center" />
                </div>
              ))}
              <div className="bg-amber-500/20 p-3 rounded-lg text-sm">
                <div className="flex justify-between"><span className="text-slate-300">×¡×”"×›:</span><span className="text-amber-400 font-bold">{fmt(total)}</span></div>
                <div className="flex justify-between"><span className="text-emerald-400">×©×•×œ×:</span><span className="text-emerald-400">{fmt(paid)}</span></div>
                <div className="flex justify-between"><span className="text-red-400">×™×ª×¨×”:</span><span className="text-red-400 font-bold">{fmt(remain)}</span></div>
              </div>
              {f.payments?.length > 0 && <div className="space-y-1">{f.payments.map((p, i) => (
                <div key={i} className="flex justify-between items-center bg-slate-700/30 p-2 rounded text-sm">
                  <span className="text-white">{fmt(p.amount)} â€¢ {p.method} â€¢ {p.date}</span>
                  <button onClick={() => delPay(i)} className="text-red-400">âŒ</button>
                </div>
              ))}</div>}
              {remain > 0 && <div className="bg-slate-700/30 p-3 rounded space-y-2">
                <div className="text-slate-300 text-sm font-bold">×”×•×¡×£ ×ª×©×œ×•×</div>
                <div className="grid grid-cols-2 gap-2">
                  <input type="date" value={pay.date} onChange={e => setPay({ ...pay, date: e.target.value })} className="bg-slate-600 text-white rounded p-2 text-sm" />
                  <input type="number" placeholder="×¡×›×•×" value={pay.amount || ''} onChange={e => setPay({ ...pay, amount: +e.target.value || 0 })} className="bg-slate-600 text-white rounded p-2 text-sm" />
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <select value={pay.method} onChange={e => setPay({ ...pay, method: e.target.value })} className="bg-slate-600 text-white rounded p-2 text-sm">
                    <option>××–×•××Ÿ</option><option>××©×¨××™</option><option>×¦'×§</option><option>×”×¢×‘×¨×”</option><option>×‘×™×˜</option>
                  </select>
                  <input placeholder="××¡××›×ª×" value={pay.reference} onChange={e => setPay({ ...pay, reference: e.target.value })} className="bg-slate-600 text-white rounded p-2 text-sm" />
                </div>
                <button onClick={addPay} className="w-full bg-emerald-500 text-white py-2 rounded font-bold text-sm">+ ×”×•×¡×£ ×ª×©×œ×•×</button>
                <button onClick={() => setPay({ ...pay, amount: Math.round(remain) })} className="text-amber-400 text-xs">××œ× ×™×ª×¨×” ({fmt(remain)})</button>
              </div>}
              <textarea placeholder="×”×¢×¨×•×ª" value={f.notes} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">×©××•×¨</button>
              {!isNew && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">××—×§</button>}
            </div>
          </Modal>
        );
      };

      const EditImport = () => {
        const isNew = !editing;
        const [f, setF] = useState(editing || { date: new Date().toISOString().split('T')[0], supplier: '', items: products.map(p => ({ productId: p.id, cartons: 0 })), productCost: 0, shipping: 0, customs: 0, insurance: 0, status: '×‘×“×¨×š', notes: '' });
        const submit = () => {
          if (isNew) {
            setImports([...imports, { ...f, id: Math.max(0, ...imports.map(i => i.id)) + 1 }]);
            if (f.status === '×”×’×™×¢') f.items.forEach(it => { if (it.cartons > 0) setInventory(inv => inv.map(i => i.productId === it.productId ? { ...i, cartons: i.cartons + it.cartons } : i)); });
          } else setImports(imports.map(i => i.id === editing.id ? { ...f, id: editing.id } : i));
          setModal(null);
        };
        const del = () => { if (window.confirm('×œ××—×•×§?')) { setImports(imports.filter(i => i.id !== editing.id)); setModal(null); } };
        return (
          <Modal title={isNew ? '×™×‘×•× ×—×“×©' : '×¢×¨×™×›×ª ×™×‘×•×'} onClose={() => setModal(null)}>
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-2">
                <input type="date" value={f.date} onChange={e => setF({ ...f, date: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3" />
                <select value={f.status} onChange={e => setF({ ...f, status: e.target.value })} className="bg-slate-700 text-white rounded-lg p-3">
                  <option>×‘×“×¨×š</option><option>×‘××›×¡</option><option>×”×’×™×¢</option>
                </select>
              </div>
              <input placeholder="×©× ×”×¡×¤×§" value={f.supplier} onChange={e => setF({ ...f, supplier: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
              <div className="text-slate-300 text-sm">×›××•×™×•×ª:</div>
              {products.map((p, idx) => (
                <div key={p.id} className="flex justify-between items-center bg-slate-700/50 p-2 rounded">
                  <span className="text-white text-sm">{p.name}</span>
                  <input type="number" min="0" value={f.items?.[idx]?.cartons || 0} onChange={e => { const items = [...f.items]; items[idx] = { productId: p.id, cartons: +e.target.value || 0 }; setF({ ...f, items }); }} className="w-16 bg-slate-600 text-white rounded p-2 text-center" />
                </div>
              ))}
              <div className="grid grid-cols-2 gap-2">
                <input type="number" placeholder="×¢×œ×•×ª ××•×¦×¨×™×" value={f.productCost} onChange={e => setF({ ...f, productCost: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" placeholder="××©×œ×•×—" value={f.shipping} onChange={e => setF({ ...f, shipping: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" placeholder="××›×¡" value={f.customs} onChange={e => setF({ ...f, customs: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
                <input type="number" placeholder="×‘×™×˜×•×—" value={f.insurance} onChange={e => setF({ ...f, insurance: +e.target.value || 0 })} className="bg-slate-700 text-white rounded-lg p-3" />
              </div>
              <div className="bg-amber-500/20 p-2 rounded text-center text-amber-400 font-bold">×¡×”"×›: {fmt(f.productCost + f.shipping + f.customs + f.insurance)}</div>
              <textarea placeholder="×”×¢×¨×•×ª" value={f.notes} onChange={e => setF({ ...f, notes: e.target.value })} className="w-full bg-slate-700 text-white rounded-lg p-3" rows="2" />
              <button onClick={submit} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">×©××•×¨</button>
              {!isNew && <button onClick={del} className="w-full bg-red-500/20 text-red-400 py-2 rounded-lg">××—×§</button>}
            </div>
          </Modal>
        );
      };

      const Dashboard = () => (
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-amber-500/20 rounded-xl p-4 border border-amber-500/30"><div className="text-amber-400 text-xs">××›×™×¨×•×ª</div><div className="text-xl font-bold text-white">{fmt(totalSales)}</div></div>
            <div className="bg-red-500/20 rounded-xl p-4 border border-red-500/30"><div className="text-red-400 text-xs">×××ª×™×Ÿ</div><div className="text-xl font-bold text-white">{fmt(pending)}</div></div>
          </div>
          <div className="grid grid-cols-2 gap-2">
            <button onClick={() => { setEditing(null); setModal('sale'); }} className="bg-amber-500 text-slate-900 font-bold py-3 rounded-xl">+ ××›×™×¨×”</button>
            <button onClick={() => { setEditing(null); setModal('customer'); }} className="bg-slate-700 text-white font-bold py-3 rounded-xl">+ ×œ×§×•×—</button>
          </div>
          <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
            <h3 className="text-white font-bold mb-3">××›×™×¨×•×ª ××—×¨×•× ×•×ª</h3>
            {[...sales].reverse().slice(0, 5).map(s => {
              const c = customers.find(x => x.id === s.customerId);
              return <div key={s.id} onClick={() => { setEditing(s); setModal('sale'); }} className="flex justify-between bg-slate-700/30 p-2 rounded-lg mb-2 cursor-pointer hover:bg-slate-700/50">
                <div><div className="text-white text-sm">{c?.name}</div><div className="text-slate-400 text-xs">{s.date}</div></div>
                <div className="text-amber-400 font-bold">{fmt(calcTotal(s))}</div>
              </div>;
            })}
          </div>
        </div>
      );

      const Inventory = () => (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-white">××œ××™</h2>
            <button onClick={() => { setEditing(null); setModal('import'); }} className="bg-amber-500 text-slate-900 px-3 py-1.5 rounded-lg font-bold text-sm">+ ×™×‘×•×</button>
          </div>
          {invBalance.map(p => (
            <div key={p.id} onClick={() => { setEditing(p); setModal('product'); }} className={`bg-slate-800/50 rounded-xl p-3 border cursor-pointer hover:bg-slate-700/50 ${p.remain < p.minStock ? 'border-red-500/50' : 'border-slate-700'}`}>
              <div className="flex justify-between">
                <div><div className="text-white font-bold">{p.name}</div><div className="text-slate-400 text-xs">{p.boxesPerCarton} ×§×•×¤/×§×¨×˜×•×Ÿ â€¢ â‚ª{p.pricePerBox}/×§×•×¤</div></div>
                <div className="text-left"><div className={`font-bold ${p.remain < p.minStock ? 'text-red-400' : 'text-white'}`}>{p.remain} ×§×¨×˜×•× ×™×</div><div className="text-emerald-400 text-xs">×¨×•×•×— 100%</div></div>
              </div>
            </div>
          ))}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
            <h3 className="text-amber-400 font-bold mb-2">×™×‘×•××™×</h3>
            {imports.map(im => (
              <div key={im.id} onClick={() => { setEditing(im); setModal('import'); }} className="bg-slate-700/30 p-2 rounded mb-2 cursor-pointer hover:bg-slate-700/50">
                <div className="flex justify-between"><span className="text-white text-sm">{im.supplier}</span><span className={`text-xs px-2 py-0.5 rounded-full ${im.status === '×”×’×™×¢' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-yellow-500/20 text-yellow-400'}`}>{im.status}</span></div>
                <div className="text-slate-400 text-xs">{im.date} â€¢ {fmt(im.productCost + im.shipping + im.customs + im.insurance)}</div>
              </div>
            ))}
          </div>
        </div>
      );

      const Sales = () => (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-white">××›×™×¨×•×ª</h2>
            <button onClick={() => { setEditing(null); setModal('sale'); }} className="bg-amber-500 text-slate-900 px-3 py-1.5 rounded-lg font-bold text-sm">+ ××›×™×¨×”</button>
          </div>
          <div className="space-y-2 max-h-[70vh] overflow-y-auto">
            {[...sales].reverse().map(s => {
              const c = customers.find(x => x.id === s.customerId);
              const total = calcTotal(s);
              const paid = (s.payments || []).reduce((sum, p) => sum + p.amount, 0);
              return <div key={s.id} onClick={() => { setEditing(s); setModal('sale'); }} className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 cursor-pointer hover:bg-slate-700/50">
                <div className="flex justify-between">
                  <div><div className="text-white font-bold">{c?.name}</div><div className="text-slate-400 text-xs">{s.date} â€¢ {s.invoiceNumber}</div></div>
                  <div className="text-left"><div className="text-amber-400 font-bold">{fmt(total)}</div>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${s.paymentStatus === '×©×•×œ×' ? 'bg-emerald-500/20 text-emerald-400' : s.paymentStatus === '×—×œ×§×™' ? 'bg-orange-500/20 text-orange-400' : 'bg-red-500/20 text-red-400'}`}>{s.paymentStatus}</span>
                  </div>
                </div>
                {s.paymentStatus !== '×©×•×œ×' && <div className="text-red-400 text-xs mt-1">×™×ª×¨×”: {fmt(total - paid)}</div>}
              </div>;
            })}
          </div>
        </div>
      );

      const Customers = () => (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-white">×œ×§×•×—×•×ª ({customers.length})</h2>
            <button onClick={() => { setEditing(null); setModal('customer'); }} className="bg-amber-500 text-slate-900 px-3 py-1.5 rounded-lg font-bold text-sm">+ ×œ×§×•×—</button>
          </div>
          <div className="space-y-2 max-h-[70vh] overflow-y-auto">
            {customers.map(c => {
              const total = sales.filter(s => s.customerId === c.id).reduce((sum, s) => sum + calcTotal(s), 0);
              return <div key={c.id} onClick={() => { setEditing(c); setModal('customer'); }} className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 cursor-pointer hover:bg-slate-700/50">
                <div className="flex justify-between">
                  <div><div className="flex items-center gap-2"><span className="text-white font-bold">{c.name}</span><span className="text-amber-400 text-xs">{'â­'.repeat(c.rating)}</span></div>
                    <div className="text-slate-400 text-xs">{c.phone} â€¢ {c.address}</div></div>
                  <div className="text-amber-400 font-bold">{fmt(total)}</div>
                </div>
              </div>;
            })}
          </div>
        </div>
      );

      const Leads = () => {
        const colors = { '×—×“×©': 'bg-blue-500/20 text-blue-400', '×¤× ×™×™×” ×¨××©×•× ×”': 'bg-yellow-500/20 text-yellow-400', '×¤×’×™×©×”': 'bg-purple-500/20 text-purple-400', '×”×¦×¢×ª ××—×™×¨': 'bg-orange-500/20 text-orange-400', '×œ× ×¨×œ×•×•× ×˜×™': 'bg-slate-500/20 text-slate-400' };
        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-white">×œ×™×“×™× ({leads.length})</h2>
              <button onClick={() => { setEditing(null); setModal('lead'); }} className="bg-amber-500 text-slate-900 px-3 py-1.5 rounded-lg font-bold text-sm">+ ×œ×™×“</button>
            </div>
            <div className="space-y-2 max-h-[70vh] overflow-y-auto">
              {leads.map(l => (
                <div key={l.id} onClick={() => { setEditing(l); setModal('lead'); }} className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 cursor-pointer hover:bg-slate-700/50">
                  <div className="flex justify-between">
                    <div><div className="flex items-center gap-2"><span className="text-white font-medium">{l.name}</span><span className={`px-2 py-0.5 rounded-full text-xs ${colors[l.status]}`}>{l.status}</span></div>
                      {l.phone && <div className="text-slate-400 text-xs">ğŸ“ {l.phone}</div>}
                      {l.notes && <div className="text-slate-500 text-xs">ğŸ“ {l.notes}</div>}</div>
                    {l.nextFollowUp && <div className="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded h-fit">ğŸ“… {l.nextFollowUp}</div>}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      };

      const Settings = () => {
        const exp = () => {
          const data = { products, inventory, sales, customers, leads, imports, targets };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `vnb-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
        };
        const imp = e => {
          const file = e.target.files[0];
          if (file) {
            const r = new FileReader();
            r.onload = ev => {
              try {
                const d = JSON.parse(ev.target.result);
                if (window.confirm('×œ×˜×¢×•×Ÿ ×’×™×‘×•×™?')) {
                  if (d.products) setProducts(d.products); if (d.inventory) setInventory(d.inventory);
                  if (d.sales) setSales(d.sales); if (d.customers) setCustomers(d.customers);
                  if (d.leads) setLeads(d.leads); if (d.imports) setImports(d.imports);
                  if (d.targets) setTargets(d.targets);
                  alert('× ×˜×¢×Ÿ!');
                }
              } catch { alert('×©×’×™××”'); }
            };
            r.readAsText(file);
          }
        };
        const reset = () => { if (window.confirm('×œ××¤×¡ ×”×›×œ?')) { localStorage.clear(); window.location.reload(); } };
        return (
          <div className="space-y-4">
            <h2 className="text-lg font-bold text-white">×”×’×“×¨×•×ª</h2>
            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
              <h3 className="text-amber-400 font-bold mb-3">×™×¢×“ ×—×•×“×©×™</h3>
              <input type="number" value={targets.monthly} onChange={e => setTargets({ ...targets, monthly: +e.target.value || 0 })} className="w-full bg-slate-700 text-white rounded-lg p-3" />
            </div>
            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
              <h3 className="text-amber-400 font-bold mb-3">×’×™×‘×•×™</h3>
              <button onClick={exp} className="w-full bg-emerald-500 text-white py-3 rounded-lg font-bold mb-2">ğŸ“¥ ×”×•×¨×“ ×’×™×‘×•×™</button>
              <label className="w-full bg-blue-500 text-white py-3 rounded-lg font-bold flex items-center justify-center cursor-pointer">ğŸ“¤ ×˜×¢×Ÿ ×’×™×‘×•×™<input type="file" accept=".json" onChange={imp} className="hidden" /></label>
            </div>
            <div className="bg-red-500/10 rounded-xl p-4 border border-red-500/30">
              <button onClick={reset} className="w-full bg-red-500 text-white py-3 rounded-lg font-bold">ğŸ—‘ï¸ ××¤×¡ ×”×›×œ</button>
            </div>
          </div>
        );
      };

      const tabs = [
        { id: 'dashboard', icon: 'ğŸ ', label: '×¨××©×™' },
        { id: 'inventory', icon: 'ğŸ“¦', label: '××œ××™' },
        { id: 'sales', icon: 'ğŸ’°', label: '××›×™×¨×•×ª' },
        { id: 'customers', icon: 'ğŸ‘¥', label: '×œ×§×•×—×•×ª' },
        { id: 'leads', icon: 'ğŸ¯', label: '×œ×™×“×™×' },
        { id: 'settings', icon: 'âš™ï¸', label: '×”×’×“×¨×•×ª' },
      ];

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900" dir="rtl">
          <header className="bg-slate-800/90 backdrop-blur sticky top-0 z-40 border-b border-slate-700">
            <div className="max-w-lg mx-auto px-4 py-3 flex justify-between items-center">
              <div><h1 className="text-xl font-bold text-amber-400">VNB</h1><p className="text-xs text-slate-400">××¢×¨×›×ª × ×™×”×•×œ</p></div>
              <div className="text-amber-400 font-bold">{fmt(totalSales)}</div>
            </div>
          </header>
          <main className="max-w-lg mx-auto px-4 py-4 pb-24">
            {tab === 'dashboard' && <Dashboard />}
            {tab === 'inventory' && <Inventory />}
            {tab === 'sales' && <Sales />}
            {tab === 'customers' && <Customers />}
            {tab === 'leads' && <Leads />}
            {tab === 'settings' && <Settings />}
          </main>
          <nav className="fixed bottom-0 left-0 right-0 bg-slate-800/95 backdrop-blur border-t border-slate-700">
            <div className="max-w-lg mx-auto px-2 py-1">
              <div className="flex justify-around">
                {tabs.map(t => (
                  <button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center py-2 px-3 rounded-lg ${tab === t.id ? 'bg-amber-500/20 text-amber-400' : 'text-slate-400'}`}>
                    <span className="text-lg">{t.icon}</span><span className="text-xs">{t.label}</span>
                  </button>
                ))}
              </div>
            </div>
          </nav>
          {modal === 'sale' && <EditSale />}
          {modal === 'customer' && <EditCustomer />}
          {modal === 'lead' && <EditLead />}
          {modal === 'product' && <EditProduct />}
          {modal === 'import' && <EditImport />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
